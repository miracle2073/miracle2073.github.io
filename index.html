@Configuration
@EnableBatchProcessing
public class BatchConfig {

    @Autowired private JobBuilderFactory jobBuilderFactory;
    @Autowired private StepBuilderFactory stepBuilderFactory;
    @Autowired private EntityManagerFactory entityManagerFactory;

    @Bean
    public JpaPagingItemReader<SourceEntity> reader() {
        JpaPagingItemReader<SourceEntity> reader = new JpaPagingItemReader<>();
        reader.setEntityManagerFactory(entityManagerFactory);
        reader.setQueryString("SELECT s FROM SourceEntity s");
        reader.setPageSize(100);
        return reader;
    }

    @Bean
    public ItemProcessor<SourceEntity, DestinationEntity> processor() {
        return source -> {
            DestinationEntity dest = new DestinationEntity();
            dest.setId(source.getId());
            dest.setName(source.getName());
            dest.setEmail(source.getEmail());
            return dest;
        };
    }

    @Bean
    public JpaItemWriter<DestinationEntity> writer() {
        JpaItemWriter<DestinationEntity> writer = new JpaItemWriter<>();
        writer.setEntityManagerFactory(entityManagerFactory);
        return writer;
    }

    @Bean
    public Step transferStep() {
        return stepBuilderFactory.get("transferStep")
                .<SourceEntity, DestinationEntity>chunk(100)
                .reader(reader())
                .processor(processor())
                .writer(writer())
                .build();
    }

    @Bean
    public Job transferJob() {
        return jobBuilderFactory.get("transferJob")
                .start(transferStep())
                .build();
    }
}
